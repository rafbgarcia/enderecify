#!/bin/sh

# Tutorial at https://cloud.google.com/community/tutorials/elixir-phoenix-on-google-compute-engine

BUCKET_NAME="enderecify-releases"
BUCKET_URL="gs://${BUCKET_NAME}/enderecify-release"

echo ""
echo ">>> Building assets for prod..."
pushd assets
npm install
npm run deploy
popd
mix phx.digest

mix clean --deps

echo ""
echo ">>> Building release..."
docker run --rm -it -v $(pwd):/app enderecify

echo ""
echo ">>> Uploading release to ${BUCKET_URL}..."
gsutil cp _build/prod/rel/states_api/bin/states_api.run $BUCKET_URL

echo ""
echo ">>> Restarting instance..."
gcloud compute instances stop enderecify-instance
gcloud compute instances start enderecify-instance
